$(function(){function t(t){var e,s,i;if(e=t.minResponseTime?new Date:null,i=function(e){if("undefined"==typeof e.error_code)try{e.error_code=e.error,e.result=e.result,0!=e.error_code&&(e.data=e.data||{},e.data.msg=e.msg)}catch(s){}0==e.error_code?("undefined"==typeof e.data&&(e.data=t.__defaultData__),t.onCallSuccessBefore&&t.onCallSuccessBefore(e),t.onSuccess&&t.onSuccess(e),t.onCallSuccessAfter&&t.onCallSuccessAfter(e)):t.onError&&t.onError(e)},t.testData)return"undefined"==typeof t.testData.data&&(t.testData.data=t.__defaultData__),void setTimeout(function(){i(t.testData)},t.minResponseTime||200);var r=window.location.host,a=t.url||t.posturl,n=t.data,o="json";if(/static.qyer.com/.test(r)===!0){var c;n=$.extend({},n,{__qFED__:t.__qFED__}),t.__qFED__&&t.__qFED__.id&&(c=t.__qFED__.id,t.type="GET"),a="http://fe.2b6.me:3000/service/api/"+c,o="jsonp",api=null}var h=$.ajax({type:t.type||"POST",url:a,dataType:o,data:n,cache:t.cache||!1,success:function(r){e?(s=new Date-e,setTimeout(function(){i.call(null,r)},s>t.minResponseTime?0:t.minResponseTime-s)):i.call(null,r),e=s=null},error:function(e,s){t.onError&&t.onError({error_code:-1,__server_error__:!0,__server_status__:h.statusText,result:"error",data:{msg:s||{}}})}});return h}function e(t){this.opts=$.extend({box:"#js_qyer_header_userStatus"},t),this.$userStatusBox=$(this.opts.box),this.ajaxUrls={userStatus:"qcross/home/ajax?action=loginstatus",msgCount:"qcross/user/ajax.php?action=getunreadcount",msgInfo:"qcross/home/ajax?action=notice"},this.hasNewMessage=!0,this.init()}function s(t){this.opts=$.extend({box:"#siteSearch"},t),this.$searchBox=$(this.opts.box),this.$input=this.$searchBox.find(".txt"),this.$form=this.$searchBox.find("form"),this.searchUrl=this.$form.attr("action"),this.ajaxUrls={sitesearch:"qcross/home/ajax?action=sitesearch"},this.searchTimer=null,this.$history=null,this.$autocomplete=null,this._history=[],this._search={},this.init()}var i={getUserStatus:function(e){t(e)},sitesearch:function(e){t(e)}},r={isParent:function(t,e){for(;void 0!=t&&null!=t&&"BODY"!=t.tagName.toUpperCase()&&"HTML"!=t.tagName.toUpperCase();){if(t==e)return!0;t=t.parentNode}return!1},loadInner:function(){return'<div class="sk-wave"><div class="sk-rect sk-rect1"></div><div class="sk-rect sk-rect2"></div><div class="sk-rect sk-rect3"></div><div class="sk-rect sk-rect4"></div><div class="sk-rect sk-rect5"></div></div>'},fliterScript:function(t){return t.replace(/<script[^>]*>[\s\S]*?<\/[^>]*script>/gi,"")}};e.prototype={init:function(){window.QYER=window.QYER||{uid:0},this.getUserStatus(),this.bindEvent()},getUserStatus:function(){var t=this;i.getUserStatus({url:this.ajaxUrls.userStatus,data:{timer:(new Date).getTime()},onSuccess:function(e){0==e.error_code&&(e.data.uid>0&&(window.QYER=window.QYER||{},window.QYER.uid=e.data.uid,t.renderUserInfoInner(e.data.userinfo)),window.__userStatusCallBack&&__userStatusCallBack.call(window,e.data))}})},renderUserInfoInner:function(t){t.msgCount&&this.$userStatusBox.find(">.user-info > .usermsg > .message > .num").text(t.msgCount);var e=['<em class="newmsg"'+(t.msgCount&&t.msgCount?"":' style="display:none;"')+"></em>",'<div class="q-layer q-layer-message">','<div class="layer-msg-tab">',"<ul>",'<li class="current'+(t.msg&&t.msg.board?" new":"")+'" data-msg-type="board"><a href="javascript:;">黑板报</a></li>',"<li"+(t.msg&&t.msg.notice?' class="new"':"")+' data-msg-type="notice"><a href="javascript:;">通知</a></li>',"<li"+(t.msg&&t.msg.message?' class="new"':"")+' data-msg-type="message"><a href="javascript:;">私信</a></li>',"</ul>","</div>",'<div class="layer-msg-container">','<div class="layer-msg-item layer-msg-item-board" style="display: block;">','<div class="layer-msg-inner"><div class="loading"></div></div>','<div class="layer-msg-more">','<a href="'+t.msgUrl.board+'"  data-bn-ipg="index-head-black-all">查看全部</a>',"</div>","</div>",'<div class="layer-msg-item layer-msg-item-notice">','<div class="layer-msg-inner"><div class="loading"></div></div>','<div class="layer-msg-more">','<a href="'+t.msgUrl.notice+'"   data-bn-ipg="index-head-notice-all">查看全部</a>',"</div>","</div>",'<div class="layer-msg-item layer-msg-item-message">','<div class="layer-msg-inner"><div class="loading"></div></div>','<div class="layer-msg-more">','<a href="'+t.msgUrl.message+'"  data-bn-ipg="index-head-letter-all">查看全部</a>',"</div>","</div>","</div>","</div>"].join("");this.$userStatusBox.find(">.user-info > .userstatus").append(t.menuInner),this.$userStatusBox.find(">.user-info > .usermsg").append(e),this.getUserMsgCount()},renderUserMsgInner:function(t){this.renderMsg("board",t.board,this.$userStatusBox.find(".layer-msg-item-board > .layer-msg-inner")),this.renderMsg("notice",t.notice,this.$userStatusBox.find(".layer-msg-item-notice > .layer-msg-inner")),this.renderMsg("message",t.message,this.$userStatusBox.find(".layer-msg-item-message > .layer-msg-inner"))},renderMsg:function(t,e,s){var i,r,a=[];switch(t){case"board":i="黑板报",r="black";break;case"notice":i="通知",r="notice";break;case"message":default:i="私信",r="letter"}if(this.$userStatusBox.find("[data-msg-type="+t+"]")[e.unread>0?"addClass":"removeClass"]("new"),e.list.length){a.push("<ul>");for(var n=0;n<e.list.length;n++){var o=e.list[n];a.push("<li"+(0==o.unread?"":' class="unread"')+">"),a.push('<div class="layer-msg-cont">'),a.push('<p class="cont">'),a.push('<a href="'+o.url+'" data-bn-ipg="index-head-msgrdrop-'+r+"List-"+n+'">'+("message"==t?o.from+": ":"")+o.msg+"</a>"),a.push("</p>"),a.push("</div>"),a.push("</li>")}a.push("</ul>")}else a.push('<div class="msg-empty">暂时没有新的'+i+"</div>");s.html(a.join(""))},getUserMsgCount:function(){var t=this,e=!0,s=0;$(window).focus(function(){e=!0}).blur(function(){e=!1});var i=function(){var i=!!s,r=10*Math.random()<7,a=!e;i||r||a||(t.hasNewMessage=!0,$.getJSON(t.ajaxUrls.msgCount,{timer:(new Date).getTime()}).done(function(e){s=e.total_count,t.$userStatusBox.find(".newmsg")[e.total_count>0?"show":"hide"](),t.$userStatusBox.find(".num").html(e.total_count)}))};setInterval(function(){i()},3e4)},getUserMsgInfo:function(){var t=this;this.hasNewMessage=!1,$.getJSON(this.ajaxUrls.msgInfo,{timer:(new Date).getTime()}).done(function(e){0==e.error_code&&t.renderUserMsgInner(e.data)})},bindEvent:function(){var t=this;this.$userStatusBox.on("click",".otherlogin-link",function(){return t.otherlogin(this.getAttribute("data-type"),this.getAttribute("url")),!1}).on("mouseenter",".userstatus,.usermsg",function(){clearTimeout(this.timer),$(this).addClass("hover"),$(this).hasClass("usermsg")&&t.hasNewMessage&&t.getUserMsgInfo()}).on("mouseleave",".userstatus,.usermsg",function(){var t=$(this);this.timer=setTimeout(function(){t.removeClass("hover")},500)}).on("click",".layer-msg-tab li",function(){if($(this).hasClass("current"))return!1;var e=this.getAttribute("data-msg-type");$(this).addClass("current").siblings().removeClass("current"),t.$userStatusBox.find(".layer-msg-item-"+e).show().siblings().hide()})},otherlogin:function(t,e){var e="http://login.qyer.com/auth.php?action="+t+"&popup=1&refer="+(e||window.location.href);window.open(e,"newwindow","width=600,height=530,top=100,left=300,toolbar=no,menubar=no,scrollbars=no,resizable=no,location=no,status=no"),e=null}},new e({}),s.prototype={init:function(){this.createHistory(),this.createAutoComplete(),this.bindEvent(),this.getStorage()},bindEvent:function(){var t=this;this.$input.on("focus",function(){t.hideLayer(),t.searchBoxActive()}),this.$input.on("keyup",function(e){switch(e.keyCode){case 38:case 37:t.switchUpDown("up");break;case 40:case 39:t.switchUpDown("down");break;default:clearTimeout(t.searchTimer),t.searchTimer=setTimeout(function(){""==t.getSearchWord()?t.showHistory():t.searchWord(t.getSearchWord())},400)}}),this.$form.on("submit",function(){var e=$.trim(t.$input.val()),s=t.searchUrl+"?wd="+window.encodeURIComponent(e);return""==e?!1:void t.setStorage(e,s)})},searchBoxActive:function(){this.$searchBox.addClass("active"),this.clickDocumentEvent(this.$searchBox[0],this.searchBoxClose),""==this.getSearchWord()?this.showHistory():this.searchWord(this.getSearchWord())},searchBoxClose:function(){this.$searchBox.removeClass("active"),this.$input.val(""),this.$history&&this.$history.removeClass("show")},clickDocumentEvent:function(t,e){var s=this,i="e_"+(new Date).getTime();$(document).unbind("click."+i),$(document).bind("click."+i,function(a){r.isParent(a.target,t)||a.target==t||(e.call(s),$(document).unbind("click."+i))})},createHistory:function(){if(!window.localStorage)return!1;var t=this,e=['<div class="q-layer q-layer-sitesearch-history">',"<ul>","</ul>",'<div class="history-clear">','<a href="javascript:;">清空历史纪录</a>',"</div>","</div>"];this.$searchBox.append(e.join("")),this.$history=this.$searchBox.find(".q-layer-sitesearch-history"),this.$history.on("click",".history-clear > a",function(){t.clearStorage()})},hideLayer:function(){this.$searchBox.find(".q-layer").removeClass("show")},showHistory:function(){if(!this._history.length)return!1;for(var t=[],e=0;e<this._history.length&&(t.push('<li data-type="history" data-wd="'+this._history[e].key+'"><a href="'+this._history[e].url+'">'+this._history[e].key+"</a></li>"),!(e>=8));e++);this.$history.find("ul").html(t.join("")),this.$history.addClass("show"),this.hideAutoComplete()},hideHistory:function(){this.$history.removeClass("show")},showAutoComplete:function(){this.$autocomplete.addClass("show")},hideAutoComplete:function(){this.$autocomplete.removeClass("show")},createAutoComplete:function(){var t=['<div class="q-layer q-layer-sitesearch-autocomplete">',"<ul>","</ul>","</div>"];this.$searchBox.append(t.join("")),this.$autocomplete=this.$searchBox.find(".q-layer-sitesearch-autocomplete")},getStorage:function(){if(window.localStorage&&window.localStorage.sitesearch_history){var t=window.localStorage.sitesearch_history;this._history=JSON.parse(t)}},setStorage:function(t,e){if(!window.localStorage)return!1;for(var s=-1,i=0;i<this._history.length;i++)if(this._history[i].key==t){s=i;break}-1!=s&&this._history.splice(i,1),this._history.unshift({key:t,url:e}),window.localStorage.sitesearch_history=JSON.stringify(this._history)},getSearchWord:function(){return r.fliterScript($.trim(this.$input.val()))},setSearchWord:function(t){this.$input.val(t)},clearStorage:function(){return window.localStorage?(window.localStorage.removeItem("sitesearch_history"),this._history=[],void this.$history.find("ul").empty()):!1},switchUpDown:function(t){this.$history.is(":visible")?this.switchUpDownInHistory(t):this.$autocomplete.is(":visible")&&this.switchUpDownInAutoComplete(t)},switchUpDownInHistory:function(t){var e=this.$history.find("li"),s=this.$history.find("li.current"),i=null;i="up"==t?s.length&&s.prev().length?s.prev():e.last():s.length&&s.next().length?s.next():e.first(),this.currentLayer(i)},switchUpDownInAutoComplete:function(t){var e=this.$autocomplete.find("li"),s=this.$autocomplete.find("li.current"),i=null;i="up"==t?s.length&&s.prev().length?s.prev():e.last():s.length&&s.next().length?s.next():e.first(),this.currentLayer(i)},currentLayer:function(t){switch(t.addClass("current").siblings().removeClass("current"),this.$form.attr("action",this.searchUrl),t.attr("data-type")){case"history":this.setSearchWord(t.attr("data-wd"));break;case"item":this.$form.attr("action",t.find("a").attr("href"));break;case"word":this.setSearchWord(t.find("a").text())}},ajaxSearch:function(t){var e=this,s={keyword:t,timer:(new Date).getTime()},r=this.ajaxUrls.sitesearch;i.sitesearch({url:r,type:"get",data:s,onSuccess:function(s){s.data.list.length?e.renderAutoComplete(e.$autocomplete,s.data,t):e.hideLayer()}})},searchWord:function(t){this._search[t]?this.renderAutoComplete(this.$autocomplete,this._search[t]):this.ajaxSearch(t)},renderAutoComplete:function(t,e,s){var i=[];if("string"==typeof e)i=e;else{for(var r=0;r<e.list.length;r++){var a=e.list[r];"item"==a.type_name?(i.push('<li data-type="item">'),i.push('<a href="'+a.url+'">'),i.push("<dl>"),i.push("<dt>"),i.push('<img src="'+a.src+'" width="30" height="30" />'),i.push("</dt>"),i.push("<dd>"),i.push("<p>"),i.push('<span class="cn">'+a.cn_name+"</span>"),i.push('<span class="en">'+a.en_name+"</span>"),i.push("</p>"),i.push("<p>"),i.push('<span class="poi">'+a.belong_name+"</span>"),i.push("</p>"),i.push("</dd>"),i.push("</dl>"),i.push("</a>"),i.push("</li>")):i.push('<li data-type="word"><a href="'+a.url+'">'+a.word+"</a></li>")}i=i.join("")}i&&(t.find("ul").html(i),this._search[s]=i),this.hideHistory(),this.showAutoComplete()},replaceKeyword:function(t,e){return t.replace(e,"<em>"+e+"</em>")}},new s({})});